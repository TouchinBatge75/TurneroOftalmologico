<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Doctor - Sistema de Turnos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .doctor-info {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .btn-logout {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .btn-logout:hover {
            background: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }

        .dashboard-content {
            padding: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border-left: 4px solid #3498db;
        }

        .card h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .turno-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #2ecc71;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .turno-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .turno-numero {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c3e50;
        }

        .turno-paciente {
            color: #34495e;
            margin-bottom: 5px;
        }

        .turno-detalles {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .btn-llamar {
            background: linear-gradient(135deg, #2ecc71 0%, #1abc9c 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            margin-top: 10px;
            width: 100%;
        }

        .btn-llamar:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
        }

        .btn-llamar:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .estado-section {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .btn-estado {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-disponible {
            background: #2ecc71;
            color: white;
        }

        .btn-ocupado {
            background: #f39c12;
            color: white;
        }

        .btn-ausente {
            background: #e74c3c;
            color: white;
        }

        .btn-estado:hover {
            transform: translateY(-2px);
        }

        .btn-estado.activo {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .consultorio-info {
            background: linear-gradient(135deg, #3498db 0%, #9b59b6 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
        }

        /* Notificaciones */
        .notificaciones-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .btn-notificacion {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            text-align: left;
        }

        .btn-notificacion:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .notificacion-personalizada {
            margin-top: 15px;
        }

        .textarea-mensaje {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 10px;
            font-family: inherit;
        }

        .btn-enviar-personalizado {
            background: #9b59b6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
        }

        .btn-enviar-personalizado:hover {
            background: #8e44ad;
            transform: translateY(-2px);
        }

        /* Derivaci√≥n de pacientes */
        .derivacion-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .destinos-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .btn-destino {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-destino:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }

        .textarea-notas {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            resize: vertical;
            min-height: 60px;
            margin-bottom: 10px;
        }

        .paciente-actual-card {
            background: linear-gradient(135deg, #2ecc71 0%, #1abc9c 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .sin-turnos {
            text-align: center;
            color: #7f8c8d;
            padding: 40px;
            font-style: italic;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .btn-logout {
                position: relative;
                top: 0;
                right: 0;
                margin-top: 15px;
            }
            
            .destinos-grid {
                grid-template-columns: 1fr;
            }
            
            .estado-section {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>üë®‚Äç‚öïÔ∏è Dashboard M√©dico</h1>
            <div class="doctor-info">
                <span id="doctor-name">Cargando...</span> - 
                <span id="consultorio-info">Consultorio: Cargando...</span>
            </div>
            <button onclick="cerrarSesion()" class="btn-logout">
                üö™ Cerrar Sesi√≥n
            </button>
        </div>

        <div class="dashboard-content">
            <!-- Columna izquierda: Estado y controles -->
            <div class="column">
                <div class="card">
                    <h3>üéØ Estado Actual</h3>
                    <div class="estado-section">
                        <button class="btn-estado btn-disponible" onclick="cambiarEstado('DISPONIBLE')">
                            ‚úÖ Disponible
                        </button>
                        <button class="btn-estado btn-ocupado" onclick="cambiarEstado('OCUPADO')">
                            ‚è≥ Ocupado
                        </button>
                        <button class="btn-estado btn-ausente" onclick="cambiarEstado('AUSENTE')">
                            ‚ùå Ausente
                        </button>
                    </div>
                    
                    <div class="consultorio-info">
                        <strong>üìç Consultorio: <span id="consultorio-numero">-</span></strong>
                    </div>

                    <button class="btn-llamar" onclick="llamarSiguiente()" id="btn-llamar">
                        üì¢ Llamar Siguiente Paciente
                    </button>
                </div>

                <div class="card">
                    <h3>üí¨ Notificaciones a Recepci√≥n</h3>
                    <div class="notificaciones-grid" id="notificaciones-predefinidas">
                        <!-- Las notificaciones se cargar√°n aqu√≠ -->
                    </div>
                    
                    <div class="notificacion-personalizada">
                        <textarea 
                            class="textarea-mensaje" 
                            placeholder="Escribe un mensaje personalizado..."
                            id="mensaje-personalizado"
                        ></textarea>
                        <button class="btn-enviar-personalizado" onclick="enviarNotificacionPersonalizada()">
                            üì§ Enviar Mensaje Personalizado
                        </button>
                    </div>
                </div>
            </div>

            <!-- Columna derecha: Lista de turnos y paciente actual -->
            <div class="column">
                <div class="card">
                    <h3>üìã Turnos en Espera</h3>
                    <div id="turnos-lista">
                        <div class="loading">Cargando turnos...</div>
                    </div>
                </div>

                <div class="card">
                    <h3>üë• Paciente en Atenci√≥n</h3>
                    <div id="paciente-actual" class="sin-turnos">
                        No hay paciente en atenci√≥n
                    </div>
                    <div id="mediciones-paciente" style="display: none;">
                        <h4>üìä Mediciones de Toma de C√°lculos:</h4>
                        <div id="mediciones-content"></div>
                    </div>

                    <!-- Secci√≥n de derivaci√≥n - solo visible cuando hay paciente en atenci√≥n -->
                    <div id="seccion-derivacion" style="display: none;">
                        <div class="derivacion-section">
                            <h4>üöÄ Derivar Paciente a:</h4>
                            <div class="destinos-grid">
                                <button class="btn-destino" onclick="derivarPaciente('FARMACIA')">
                                    üíä Farmacia
                                </button>
                                <button class="btn-destino" onclick="derivarPaciente('ASESORIA_VISUAL')">
                                    üëì Asesor√≠a Visual
                                </button>
                                <button class="btn-destino" onclick="derivarPaciente('ESTUDIOS_ESPECIALES')">
                                    üî¨ Estudios Especiales
                                </button>
                                <button class="btn-destino" onclick="derivarPaciente('TOMA_CALCULOS')">
                                    üìä Toma de Calculos
                                </button>
                                <button class="btn-destino" onclick="derivarPaciente('TRABAJO_SOCIAL')">
                                    üõÇ Trabajo Social
                                </button>
                                <button class="btn-destino" onclick="derivarPaciente('SALIDA')">
                                    üö™ Salida
                                </button>
                            </div>
                            
                            <div class="checkbox-group">
                                <input type="checkbox" id="vuelve-conmigo">
                                <label for="vuelve-conmigo">üîÑ El paciente regresar√° a consulta</label>
                            </div>
                            
                            <textarea 
                                class="textarea-notas" 
                                placeholder="Notas adicionales..."
                                id="notas-derivacion"
                            ></textarea>
                            
                            <button class="btn-llamar" onclick="confirmarDerivacion()">
                                ‚úÖ Confirmar Derivaci√≥n
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let doctorId = null;
        let doctorNombre = null;
        let consultorioNumero = null;
        let pacienteActual = null;
        let destinoSeleccionado = null;
        let notificacionesPredefinidas = {};

        // Cargar informaci√≥n al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üè• Iniciando dashboard m√©dico...');
            
            // Obtener datos de la sesi√≥n
            doctorId = sessionStorage.getItem('doctor_id');
            doctorNombre = sessionStorage.getItem('doctor_nombre');
            consultorioNumero = sessionStorage.getItem('consultorio_numero');
            
            console.log('üìã Datos de sesi√≥n:', { doctorId, doctorNombre, consultorioNumero });
            
            // Verificar sesi√≥n
            if (!doctorId) {
                console.error('‚ùå No hay sesi√≥n activa');
                alert('No hay sesi√≥n activa. Redirigiendo al login...');
                window.location.href = '/doctor-login';
                return;
            }
            
            // Mostrar informaci√≥n del doctor
            document.getElementById('doctor-name').textContent = doctorNombre;
            document.getElementById('consultorio-info').textContent = `Consultorio: ${consultorioNumero}`;
            document.getElementById('consultorio-numero').textContent = consultorioNumero;
            
            console.log('‚úÖ Dashboard configurado para:', doctorNombre);
            
            // Cargar datos iniciales
            cargarTurnos();
            cargarPacienteActual();
            cargarNotificacionesPredefinidas();
            actualizarEstadoDoctor();
            
            // Actualizar cada 5 segundos
            setInterval(() => {
                cargarTurnos();
                cargarPacienteActual();
            }, 5000);
        });

        // Funci√≥n para cerrar sesi√≥n
        function cerrarSesion() {
            if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n? Esto liberar√° tu consultorio.')) {
                fetch('/api/doctor/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        doctor_id: parseInt(doctorId)
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Limpiar sessionStorage
                        sessionStorage.clear();
                        // Redirigir al login
                        window.location.href = '/doctor-login';
                    } else {
                        alert('Error al cerrar sesi√≥n: ' + (data.error || 'Error desconocido'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al conectar con el servidor');
                });
            }
        }

        // Funci√≥n para cargar turnos en espera
        function cargarTurnos() {
            if (!doctorId) return;
            
            fetch(`/api/doctor/turnos?doctor_id=${doctorId}`)
                .then(response => response.json())
                .then(turnos => {
                    const lista = document.getElementById('turnos-lista');
                    
                    if (turnos.length === 0) {
                        lista.innerHTML = '<div class="sin-turnos">No hay turnos en espera</div>';
                        return;
                    }
                    
                    lista.innerHTML = turnos.map(turno => `
                        <div class="turno-item">
                            <div class="turno-header">
                                <span class="turno-numero">${turno.numero}</span>
                            </div>
                            <div class="turno-paciente">
                                <strong>${turno.paciente_nombre}</strong> (${turno.paciente_edad} a√±os)
                            </div>
                            <div class="turno-detalles">
                                Tipo: ${turno.tipo} | Estaci√≥n: ${turno.estacion_actual_nombre}
                            </div>
                        </div>
                    `).join('');
                })
                .catch(error => {
                    console.error('Error cargando turnos:', error);
                    document.getElementById('turnos-lista').innerHTML = 
                        '<div class="sin-turnos">Error cargando turnos</div>';
                });
        }

        // Funci√≥n para cargar paciente en atenci√≥n
        function cargarPacienteActual() {
            if (!doctorId) return;
            
            fetch(`/api/doctor/paciente-actual?doctor_id=${doctorId}`)
                .then(response => response.json())
                .then(data => {
                    const contenedor = document.getElementById('paciente-actual');
                    const seccionDerivacion = document.getElementById('seccion-derivacion');
                    const medicionesContainer = document.getElementById('mediciones-paciente');
                    
                    if (data.paciente) {
                        pacienteActual = data.paciente;
                        contenedor.innerHTML = `
                            <div class="paciente-actual-card">
                                <div class="turno-header">
                                    <span class="turno-numero">${data.paciente.numero}</span>
                                </div>
                                <div class="turno-paciente">
                                    <strong>${data.paciente.paciente_nombre}</strong> (${data.paciente.paciente_edad} a√±os)
                                </div>
                                <div class="turno-detalles" style="color: white; opacity: 0.9;">
                                    Tipo: ${data.paciente.tipo} | En atenci√≥n desde: ${new Date(data.paciente.timestamp_atencion).toLocaleTimeString()}
                                </div>
                            </div>
                        `;
                        seccionDerivacion.style.display = 'block';

                        cargarMedicionesPaciente(data.paciente.id);

                    } else {
                        pacienteActual = null;
                        contenedor.innerHTML = '<div class="sin-turnos">No hay paciente en atenci√≥n</div>';
                        seccionDerivacion.style.display = 'none';
                        medicionesContainer.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error cargando paciente actual:', error);
                });
        }

        // Funci√≥n para cargar notificaciones predefinidas
        function cargarNotificacionesPredefinidas() {
            fetch('/api/doctor/notificaciones/predefinidas')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        notificacionesPredefinidas = data.notificaciones;
                        const contenedor = document.getElementById('notificaciones-predefinidas');
                        
                        contenedor.innerHTML = Object.entries(data.notificaciones).map(([key, mensaje]) => `
                            <button class="btn-notificacion" onclick="enviarNotificacionPredefinida('${key}')">
                                ${mensaje}
                            </button>
                        `).join('');
                    }
                })
                .catch(error => {
                    console.error('Error cargando notificaciones:', error);
                });
        }

        // Funci√≥n para cargar mediciones del paciente actual
function cargarMedicionesPaciente(turnoId) {
    if (!turnoId) return;
    
    fetch(`/api/mediciones/${turnoId}`)
        .then(response => response.json())
        .then(data => {
            const medicionesContainer = document.getElementById('mediciones-paciente');
            const medicionesContent = document.getElementById('mediciones-content');
            
            if (data.mediciones) {
                // Mostrar las mediciones
                medicionesContent.innerHTML = `
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 10px;">
                        <strong>üëÅÔ∏è Agudeza Visual:</strong> 
                        ${data.mediciones.agudeza_visual_od || 'N/A'} OD / 
                        ${data.mediciones.agudeza_visual_oi || 'N/A'} OI<br>
                        
                        <strong>üìä Presi√≥n Intraocular:</strong> 
                        ${data.mediciones.presion_intraocular_od || 'N/A'} OD / 
                        ${data.mediciones.presion_intraocular_oi || 'N/A'} OI<br>
                        
                        <strong>üîç Queratometr√≠a:</strong> 
                        ${data.mediciones.queratometria_od || 'N/A'} OD / 
                        ${data.mediciones.queratometria_oi || 'N/A'} OI<br>
                        
                        <strong>üëì Refracci√≥n:</strong> 
                        ${data.mediciones.refraccion_od || 'N/A'} OD / 
                        ${data.mediciones.refraccion_oi || 'N/A'} OI<br>
                        
                        ${data.mediciones.observaciones ? 
                            `<strong>üìù Observaciones:</strong> ${data.mediciones.observaciones}<br>` : ''}
                        
                        ${data.mediciones.atendido_por ? 
                            `<strong>üë§ Atendido por:</strong> ${data.mediciones.atendido_por}<br>` : ''}
                            
                        <small style="color: #7f8c8d;">
                            üìÖ ${new Date(data.mediciones.timestamp).toLocaleString()}
                        </small>
                    </div>
                `;
                medicionesContainer.style.display = 'block';
            } else {
                medicionesContainer.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error cargando mediciones:', error);
            document.getElementById('mediciones-paciente').style.display = 'none';
        });
}

        // Funci√≥n para llamar siguiente paciente
        function llamarSiguiente() {
            const btn = document.getElementById('btn-llamar');
            btn.disabled = true;
            btn.textContent = '‚è≥ Llamando...';
            
            fetch('/api/doctor/llamar-siguiente', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    doctor_id: parseInt(doctorId)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarNotificacion(`üì¢ Llamando a: ${data.turno.numero} - ${data.turno.paciente_nombre}`);
                    cargarTurnos();
                    cargarPacienteActual();
                } else {
                    alert(data.error || 'Error al llamar paciente');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al conectar con el servidor');
            })
            .finally(() => {
                btn.disabled = false;
                btn.textContent = 'üì¢ Llamar Siguiente Paciente';
            });
        }

        // Funci√≥n para cambiar estado del doctor
        function cambiarEstado(estado) {
            fetch('/api/doctor/cambiar-estado', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    doctor_id: parseInt(doctorId),
                    estado: estado
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Actualizar botones visualmente
                    document.querySelectorAll('.btn-estado').forEach(btn => {
                        btn.classList.remove('activo');
                    });
                    event.target.classList.add('activo');
                    
                    let mensaje = '';
                    switch(estado) {
                        case 'DISPONIBLE':
                            mensaje = '‚úÖ Estado actualizado: Disponible';
                            break;
                        case 'OCUPADO':
                            mensaje = '‚è≥ Estado actualizado: Ocupado';
                            break;
                        case 'AUSENTE':
                            mensaje = '‚ùå Estado actualizado: Ausente';
                            break;
                    }
                    
                    mostrarNotificacion(mensaje);
                } else {
                    alert('Error al cambiar estado: ' + (data.error || 'Error desconocido'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al conectar con el servidor');
            });
        }

        // Funci√≥n para enviar notificaci√≥n predefinida
        function enviarNotificacionPredefinida(tipo) {
            const mensaje = notificacionesPredefinidas[tipo];
            
            fetch('/api/doctor/notificar-recepcion', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    doctor_id: parseInt(doctorId),
                    doctor_nombre: doctorNombre,
                    consultorio: consultorioNumero,
                    mensaje: mensaje,
                    tipo: tipo
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarNotificacion('‚úÖ Notificaci√≥n enviada a recepci√≥n');
                } else {
                    alert('Error: ' + (data.error || 'Error enviando notificaci√≥n'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al conectar con el servidor');
            });
        }

        // Funci√≥n para enviar notificaci√≥n personalizada
        function enviarNotificacionPersonalizada() {
            const mensaje = document.getElementById('mensaje-personalizado').value.trim();
            
            if (!mensaje) {
                alert('Por favor escribe un mensaje');
                return;
            }
            
            fetch('/api/doctor/notificacion-personalizada', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    doctor_id: parseInt(doctorId),
                    doctor_nombre: doctorNombre,
                    consultorio: consultorioNumero,
                    mensaje: mensaje
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarNotificacion('‚úÖ Mensaje personalizado enviado');
                    document.getElementById('mensaje-personalizado').value = '';
                } else {
                    alert('Error: ' + (data.error || 'Error enviando mensaje'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al conectar con el servidor');
            });
        }

        // Funci√≥n para derivar paciente
        function derivarPaciente(destino) {
            destinoSeleccionado = destino;
            
            // Resaltar bot√≥n seleccionado
            document.querySelectorAll('.btn-destino').forEach(btn => {
                btn.style.background = '#3498db';
            });
            event.target.style.background = '#2980b9';
        }

        // Funci√≥n para confirmar derivaci√≥n
        function confirmarDerivacion() {
            if (!destinoSeleccionado) {
                alert('Por favor selecciona un destino');
                return;
            }
            
            if (!pacienteActual) {
                alert('No hay paciente en atenci√≥n');
                return;
            }
            
            const vuelveConmigo = document.getElementById('vuelve-conmigo').checked;
            const notas = document.getElementById('notas-derivacion').value;
            
            fetch('/api/doctor/derivar-paciente', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    turno_id: pacienteActual.id,
                    destino: destinoSeleccionado,
                    vuelve_conmigo: vuelveConmigo,
                    notas: notas
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let mensaje = `‚úÖ Paciente derivado a ${destinoSeleccionado}`;
                    if (data.vuelve_conmigo) {
                        mensaje += ' (Regresar√° a consulta)';
                    }
                    mostrarNotificacion(mensaje);
                    
                    // Limpiar formulario
                    destinoSeleccionado = null;
                    document.getElementById('vuelve-conmigo').checked = false;
                    document.getElementById('notas-derivacion').value = '';
                    document.querySelectorAll('.btn-destino').forEach(btn => {
                        btn.style.background = '#3498db';
                    });
                    
                    // Recargar datos
                    cargarPacienteActual();
                    cargarTurnos();
                } else {
                    alert('Error: ' + (data.error || 'Error derivando paciente'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al conectar con el servidor');
            });
        }

        // Funci√≥n para actualizar estado del doctor (inicial)
        function actualizarEstadoDoctor() {
            // Por defecto, marcar como disponible
            document.querySelector('.btn-disponible').classList.add('activo');
        }

        // Funci√≥n auxiliar para mostrar notificaciones
        function mostrarNotificacion(mensaje) {
            const notificacion = document.createElement('div');
            notificacion.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #2ecc71;
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                z-index: 1000;
                font-weight: 600;
            `;
            notificacion.textContent = mensaje;
            document.body.appendChild(notificacion);
            
            setTimeout(() => {
                document.body.removeChild(notificacion);
            }, 3000);
        }
    </script>
</body>
</html>